<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Demo: Central Hidroeléctrica (SVG + HTML)</title>
  <style>
    :root{--sky:#87ceeb;--water:#1e90ff;--dam:#bdbdbd;--concrete:#9b9b9b;--turbine:#2f4f4f}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial}
    .wrap{min-height:100vh;display:grid;place-items:center;padding:18px;background:linear-gradient(180deg,var(--sky) 0%, #dff0ff 70%)}
    .card{width:960px;max-width:96vw;background:linear-gradient(180deg,rgba(255,255,255,0.9),#fff);border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.12);padding:18px}
    h1{font-size:20px;margin:0 0 12px}
    p{margin:0 0 8px;color:#333}
    .scene{width:100%;height:480px}

    /* Wave animation */
    .water-wave{animation:wave 6s linear infinite}
    @keyframes wave{
      from{transform:translateX(0)}
      to{transform:translateX(-160px)}
    }

    /* Turbine rotation */
    .blade{transform-origin:center;animation:spin 1.5s linear infinite}
    .blade.paused{animation-play-state:paused}
    @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}

    /* small controls */
    .controls{display:flex;gap:8px;align-items:center;margin-top:12px}
    button{background:#1976d2;color:white;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    button.secondary{background:#eee;color:#222}
    .label{font-size:13px;color:#444}

    /* Responsive tweaks */
    @media (max-width:520px){.scene{height:320px}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="main">
      <h1>Visualización: Central Hidroeléctrica (demo)</h1>
      <p>Modelo simplificado con SVG: presa, embalse, flujo de agua y turbinas rotando. Usa los controles para pausar/reanudar.</p>

      <!-- SVG scene -->
      <svg class="scene" viewBox="0 0 1200 600" aria-label="Ilustración de una central hidroeléctrica simplificada" role="img">
        <!-- Sky gradient -->
        <defs>
          <linearGradient id="skyGrad" x1="0" x2="0" y1="0" y2="1">
            <stop offset="0%" stop-color="#a9ddff"></stop>
            <stop offset="100%" stop-color="#e6f7ff"></stop>
          </linearGradient>
          <linearGradient id="waterGrad" x1="0" x2="0" y1="0" y2="1">
            <stop offset="0%" stop-color="#4fb0ff"></stop>
            <stop offset="100%" stop-color="#0066cc"></stop>
          </linearGradient>
          <filter id="softShadow" x="-20%" y="-20%" width="140%" height="140%">
            <feDropShadow dx="0" dy="8" stdDeviation="10" flood-opacity="0.15"/>
          </filter>
        </defs>

        <!-- Sky background -->
        <rect x="0" y="0" width="1200" height="380" fill="url(#skyGrad)" />

        <!-- Hills behind -->
        <path d="M0 300 C160 200 340 220 600 300 C820 360 980 280 1200 300 L1200 380 L0 380 Z" fill="#7fb07f" opacity="0.65"/>

        <!-- Reservoir (behind dam) -->
        <g id="reservoir">
          <rect x="0" y="160" width="840" height="220" fill="url(#waterGrad)"/>
          <!-- waves pattern: repeated rectangles moving left -->
          <g class="water-wave" id="waves" transform="translate(0,0)">
            <path d="M-160 270 q40 -12 80 0 t80 0 t80 0 t80 0 t80 0" fill="none" stroke="#bfe6ff" stroke-width="8" opacity="0.18"/>
            <path d="M-80 290 q40 -8 80 0 t80 0 t80 0 t80 0" fill="none" stroke="#cfeeff" stroke-width="6" opacity="0.14"/>
          </g>
        </g>

        <!-- Dam structure -->
        <g id="dam">
          <!-- sloped face -->
          <path d="M840 160 L980 400 L1200 400 L1200 600 L760 600 L760 400 L840 160 Z" fill="#bdbdbd" stroke="#9b9b9b" stroke-width="2" filter="url(#softShadow)"/>
          <!-- spillway openings -->
          <g transform="translate(860,360)">
            <rect x="0" y="0" width="50" height="40" rx="6" fill="#6e6e6e"/>
            <rect x="70" y="0" width="50" height="40" rx="6" fill="#6e6e6e"/>
          </g>
        </g>

        <!-- Penstock (pipe) delivering water under dam to turbines -->
        <g id="penstock">
          <path d="M920 360 C980 420 1020 460 1020 520" stroke="#5b5b5b" stroke-width="36" stroke-linecap="round" fill="none"/>
        </g>

        <!-- Powerhouse with turbines (foreground) -->
        <g id="powerhouse" transform="translate(960,480)">
          <rect x="0" y="-120" width="420" height="120" rx="8" fill="#efefef" stroke="#c9c9c9"/>
          <rect x="10" y="-110" width="60" height="100" rx="4" fill="#d6d6d6"/>
          <text x="200" y="-70" font-size="18" text-anchor="middle" fill="#333">Central Hidroeléctrica</text>

          <!-- Turbines - 3 units -->
          <g transform="translate(60,-10)">
            <g class="turbine" data-id="t1" transform="translate(0,0)">
              <circle cx="0" cy="0" r="36" fill="#eee" stroke="#bbb" stroke-width="4"/>
              <g class="blade" id="blade1"></g>
            </g>

            <g class="turbine" data-id="t2" transform="translate(140,0)">
              <circle cx="0" cy="0" r="36" fill="#eee" stroke="#bbb" stroke-width="4"/>
              <g class="blade" id="blade2"></g>
            </g>

            <g class="turbine" data-id="t3" transform="translate(280,0)">
              <circle cx="0" cy="0" r="36" fill="#eee" stroke="#bbb" stroke-width="4"/>
              <g class="blade" id="blade3"></g>
            </g>
          </g>
        </g>

        <!-- Tailrace (river below turbines) -->
        <rect x="0" y="520" width="1200" height="80" fill="url(#waterGrad)" />
        <g transform="translate(0,520)" class="water-wave">
          <path d="M0 30 q40 -12 80 0 t80 0 t80 0 t80 0 t80 0 t80 0" fill="none" stroke="#bfe6ff" stroke-width="8" opacity="0.18"/>
        </g>

        <!-- Labels (accessible) -->
        <g font-size="14" fill="#123">
          <text x="100" y="200">Embalse</text>
          <text x="880" y="220">Presa / Casa de máquinas</text>
          <text x="1020" y="520">Turbinas</text>
        </g>
      </svg>

      <div class="controls" aria-hidden="false">
        <button id="toggle">Pausar turbinas</button>
        <button id="slow" class="secondary">Reducir velocidad</button>
        <button id="fast" class="secondary">Aumentar velocidad</button>
        <div class="label">Velocidad: <span id="speedLabel">1.0x</span></div>
      </div>

      <!-- Panel de simulación -->
      <div style="margin-top:20px; padding:12px; border:1px solid #ccc; border-radius:8px; background:#f9f9f9;">
        <h3>Simulación energética</h3>
        <label>Altura del embalse (m): <input type="number" id="altura" value="50"></label><br>
        <label>Cantidad de turbinas: <input type="number" id="turbinas" value="3"></label><br>
        <label>Caudal por turbina (m³/s): <input type="number" id="caudal" value="40"></label><br>
        <label>Eficiencia (%): <input type="number" id="eficiencia" value="90"></label><br>
        <button id="calcular">Calcular producción</button>

        <div id="resultados" style="margin-top:12px; font-size:14px; color:#333;"></div>
        <canvas id="grafico" width="400" height="200" style="margin-top:20px; background:#fff; border:1px solid #ddd;"></canvas>
      </div>
      </div>

      <div style="margin-top:10px;font-size:13px;color:#555">Nota: este es un esquema simplificado para propósitos ilustrativos.</div>
    </div>
  </div>

  <script>
    // Parámetros físicos
    const RHO = 1000; // kg/m3
    const G = 9.81; // m/s2
    const CO2_FACTOR = 0.475; // kgCO2 per kWh (valor por defecto)

    // Elementos DOM
    const alturaEl = document.getElementById('altura');
    const turbinasEl = document.getElementById('turbinas');
    const caudalEl = document.getElementById('caudal');
    const eficienciaEl = document.getElementById('eficiencia');
    const calcularBtn = document.getElementById('calcular');
    const resultadosDiv = document.getElementById('resultados');
    const grafico = document.getElementById('grafico');
    const ctx = grafico.getContext('2d');

    // SVG references para actualizar visualmente
    const reservoirRect = document.querySelector('#reservoir rect');
    const wavesGroup = document.querySelector('#waves');
    const turbinesContainer = document.querySelector('#powerhouse g[transform="translate(60,-10)"]');

    // Control de velocidad y animación previo
    const blades = () => Array.from(document.querySelectorAll('.blade'));
    const toggleBtn = document.getElementById('toggle');
    const slowBtn = document.getElementById('slow');
    const fastBtn = document.getElementById('fast');
    const speedLabel = document.getElementById('speedLabel');
    let speed = 1.0; // multiplier
    function applySpeed(){
      blades().forEach(b=>{
        b.style.animationDuration = (1.5 / speed) + 's';
      });
      speedLabel.textContent = speed.toFixed(2) + 'x';
    }
    applySpeed();
    toggleBtn.addEventListener('click', ()=>{
      const list = blades();
      if(!list.length) return;
      const paused = list[0].classList.toggle('paused');
      toggleBtn.textContent = paused ? 'Reanudar turbinas' : 'Pausar turbinas';
    });
    slowBtn.addEventListener('click', ()=>{ speed = Math.max(0.2, speed - 0.25); applySpeed(); });
    fastBtn.addEventListener('click', ()=>{ speed = Math.min(6, speed + 0.25); applySpeed(); });

    // Mapea la altura introducida a la altura visual del embalse (0-100 m -> 0-220px)
    function updateReservoirVisual(altura){
      const maxVisualH = 220; // px
      const clampH = Math.max(0, Math.min(altura, 200));
      const newH = (clampH / 100) * maxVisualH; // map 0-100m to 0-220px
      const baseY = 160; // y original
      const y = baseY + (maxVisualH - newH);
      reservoirRect.setAttribute('y', String(y));
      reservoirRect.setAttribute('height', String(Math.max(6, newH)));
      // mover ondas
      wavesGroup.setAttribute('transform', `translate(0,${y+newH-110})`);
    }

    // Crea un rotor estilizado en SVG (centerX relative)
    function createRotor(cx){
      const svgns = 'http://www.w3.org/2000/svg';
      const g = document.createElementNS(svgns,'g');
      g.setAttribute('class','turbine');
      g.setAttribute('transform', `translate(${cx},0)`);
      // carcasa
      const circ = document.createElementNS(svgns,'circle');
      circ.setAttribute('cx','0'); circ.setAttribute('cy','0'); circ.setAttribute('r','36');
      circ.setAttribute('fill','#eee'); circ.setAttribute('stroke','#bbb'); circ.setAttribute('stroke-width','4');
      g.appendChild(circ);
      // rotor (3 palas curvadas) dentro de un grupo que rota
      const rotor = document.createElementNS(svgns,'g');
      rotor.setAttribute('class','blade');
      rotor.setAttribute('style','transform-origin:0px 0px;');
      // usar paths para simular palas
      const pathData = [
        'M0 -26 C8 -18 14 -8 12 0 C10 8 4 14 0 16 C-4 14 -10 8 -12 0 C-14 -8 -8 -18 0 -26 Z',
        'M26 0 C18 8 8 14 0 12 C-8 10 -14 4 -16 0 C-14 -4 -8 -10 0 -12 C8 -14 18 -8 26 0 Z',
        'M0 26 C-8 18 -14 8 -12 0 C-10 -8 -4 -14 0 -16 C4 -14 10 -8 12 0 C14 8 8 18 0 26 Z'
      ];
      pathData.forEach(d=>{
        const p = document.createElementNS(svgns,'path');
        p.setAttribute('d', d);
        p.setAttribute('fill','#555');
        rotor.appendChild(p);
      });
      g.appendChild(rotor);
      return g;
    }

    // Actualiza número de turbinas (mantiene posicionamiento dentro de la caja)
    function updateTurbinesVisual(count){
      // limpiar contenedor
      while (turbinesContainer.firstChild) turbinesContainer.removeChild(turbinesContainer.firstChild);
      const spacing = 120; // px entre turbinas
      for(let i=0;i<count;i++){
        const cx = i * spacing;
        const rotor = createRotor(cx);
        turbinesContainer.appendChild(rotor);
      }
      applySpeed();
    }

    // Formatea números con separador y decimales
    function fmt(n,dec=2){
      return Number(n).toLocaleString(undefined, {minimumFractionDigits:dec, maximumFractionDigits:dec});
    }

    // Dibuja gráfico de barras mensuales en canvas (MWh)
    function drawMonthlyChart(monthlyMWh){
      const width = grafico.width; const height = grafico.height; const padding = 30;
      ctx.clearRect(0,0,width,height);
      // ejes
      ctx.strokeStyle = '#999'; ctx.lineWidth = 1; ctx.beginPath(); ctx.moveTo(padding, padding); ctx.lineTo(padding, height-padding); ctx.lineTo(width-padding, height-padding); ctx.stroke();
      // encontrar max
      const maxVal = Math.max(...monthlyMWh, 1);
      const barWidth = (width - padding*2) / monthlyMWh.length * 0.7;
      monthlyMWh.forEach((v,i)=>{
        const x = padding + i * ((width - padding*2)/monthlyMWh.length) + ((width - padding*2)/monthlyMWh.length - barWidth)/2;
        const h = ( (v / maxVal) * (height - padding*2) );
        ctx.fillStyle = '#1976d2';
        ctx.fillRect(x, height - padding - h, barWidth, h);
        // label mes (abreviado)
        ctx.fillStyle = '#222'; ctx.font = '10px sans-serif';
        const meses = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
        ctx.fillText(meses[i], x+2, height - padding + 12);
      });
      // valor max text
      ctx.fillStyle='#333'; ctx.font='11px sans-serif'; ctx.fillText('Producción mensual estimada (MWh)', padding, padding-8);
    }

    // Función principal de cálculo
    function calcular(){
      const H = parseFloat(alturaEl.value) || 0; // m
      const n = parseInt(turbinasEl.value) || 0;
      const q = parseFloat(caudalEl.value) || 0; // m3/s por turbina
      const eta = (parseFloat(eficienciaEl.value) || 0)/100; // decimal

      // actualizar visuales
      updateReservoirVisual(H);
      updateTurbinesVisual(Math.max(0, Math.min(n, 8))); // limitar a 8 turbinas visuales

      const Q_total = n * q; // m3/s total
      const potenciaW = RHO * G * Q_total * H * eta; // W
      const potenciaKW = potenciaW / 1000;
      // producciones
      const secondsPerDay = 86400;
      const dailyMWh = potenciaW * secondsPerDay / 1e6; // MWh/día
      // meses (no año bisiesto)
      const diasMes = [31,28,31,30,31,30,31,31,30,31,30,31];
      const monthlyMWh = diasMes.map(d => dailyMWh * d);
      const annualMWh = monthlyMWh.reduce((a,b)=>a+b,0);

      // CO2 evitado (kg CO2) -> convertir MWh a kWh: *1000
      const annualkWh = annualMWh * 1000;
      const co2AvoidedKg = annualkWh * CO2_FACTOR; // kg
      const co2AvoidedTon = co2AvoidedKg / 1000;

      // mostrar resultados
      resultadosDiv.innerHTML = `
        <strong>Resultados</strong><br>
        Potencia instantánea: <strong>${fmt(potenciaKW,2)} kW</strong><br>
        Producción estimada diaria: <strong>${fmt(dailyMWh,3)} MWh/día</strong><br>
        Producción estimada mensual (promedio): <strong>${fmt(annualMWh/12,3)} MWh/mes</strong><br>
        Producción estimada anual: <strong>${fmt(annualMWh,2)} MWh/año</strong><br>
        Caudal total: <strong>${fmt(Q_total,2)} m³/s</strong><br>
        CO₂ evitado anual (aprox.): <strong>${fmt(co2AvoidedTon,2)} tCO₂/año</strong>
      `;

      // dibujar gráfico
      drawMonthlyChart(monthlyMWh);
    }

    // eventos
    calcularBtn.addEventListener('click', calcular);

    // calcular al cargar con valores por defecto
    window.addEventListener('load', ()=>{ calcular(); });

  </script>
</body>
</html>
